name: Discord Repo Updates

on:
  push:
    branches: ["**"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord embed (push)
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"

          # Push payload fields
          COMMIT_COUNT='${{ github.event.commits && github.event.commits.length || 1 }}'
          COMMIT_MSG='${{ github.event.head_commit.message }}'
          COMMIT_URL='${{ github.event.head_commit.url }}'
          COMPARE_URL='${{ github.event.compare }}'

          # GitHub avatar (simple + reliable)
          AVATAR_URL="https://github.com/${ACTOR}.png?size=64"

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [
                {
                  \"author\": {
                    \"name\": \"${ACTOR}\",
                    \"icon_url\": \"${AVATAR_URL}\"
                  },
                  \"title\": \"[${REPO}:${BRANCH}] ${COMMIT_COUNT} new commit(s)\",
                  \"url\": \"${COMPARE_URL}\",
                  \"description\": \"[${SHORT_SHA}](${COMMIT_URL}) ${COMMIT_MSG}\",
                  \"footer\": { \"text\": \"GitHub Push\" }
                }
              ]
            }" \
            "$WEBHOOK"
