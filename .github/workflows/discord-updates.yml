name: Discord Repo Updates

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord embed (push)
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMPARE_URL: ${{ github.event.compare }}
        run: |
          SHORT_SHA="${SHA:0:7}"
          AVATAR_URL="https://github.com/${ACTOR}.png?size=128"
          REPO_NAME=$(echo "${REPO}" | awk -F/ '{print $2}')
          REPO_OWNER=$(echo "${REPO}" | awk -F/ '{print $1}')
          
          # Format commit message (take first line, clean up)
          COMMIT_FIRST_LINE=$(echo "${COMMIT_MSG}" | head -1)
          CLEAN_COMMIT_MSG=$(echo "${COMMIT_FIRST_LINE}" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
          
          # Get current time in Discord timestamp format
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [
                {
                  \"color\": 	12406784,
                  \"author\": { 
                    \"name\": \"${REPO_OWNER}/${REPO_NAME}\",
                    \"url\": \"https://github.com/${REPO}\",
                    \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                  },
                  \"title\": \"üì§ New Push Event\",
                  \"url\": \"${COMPARE_URL}\",
                  \"description\": \"A new push has been made to the repository.\",
                  \"fields\": [
                    {
                      \"name\": \"üë§ Author\",
                      \"value\": \"[${ACTOR}](https://github.com/${ACTOR})\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"üåø Branch\",
                      \"value\": \"\`${BRANCH}\`\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"üîó Commit Hash\",
                      \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"üìù Commit Message\",
                      \"value\": \"${CLEAN_COMMIT_MSG}\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"üîç View Changes\",
                      \"value\": \"[Compare Changes](${COMPARE_URL})\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"üïê Timestamp\",
                      \"value\": \"<t:$(date -d \"${CURRENT_TIME}\" +%s):R>\",
                      \"inline\": true
                    }
                  ],
                  \"thumbnail\": { 
                    \"url\": \"${AVATAR_URL}\"
                  },
                  \"footer\": { 
                    \"text\": \"GitHub Actions ‚Ä¢ Repository Update\",
                    \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                  },
                  \"timestamp\": \"${CURRENT_TIME}\"
                }
              ]
            }" \
            "$WEBHOOK"